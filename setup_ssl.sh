#!/bin/bash

echo "üîê –ù–∞—Å—Ç—Ä–æ–π–∫–∞ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ –¥–ª—è testdlyavsego.ru"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –¥–æ–º–µ–Ω —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ –Ω–∞—à IP
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ DNS –∑–∞–ø–∏—Å–µ–π..."
CURRENT_IP=$(curl -4 -s ifconfig.me)
DOMAIN_IP=$(nslookup testdlyavsego.ru | grep "Address:" | tail -1 | awk '{print $2}')

echo "–í–∞—à IP: $CURRENT_IP"
echo "IP –¥–æ–º–µ–Ω–∞: $DOMAIN_IP"

if [ "$CURRENT_IP" != "$DOMAIN_IP" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: –î–æ–º–µ–Ω testdlyavsego.ru —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ $DOMAIN_IP, –∞ –≤–∞—à IP $CURRENT_IP"
    echo "üìù –ù—É–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å A-–∑–∞–ø–∏—Å—å –≤ –ø–∞–Ω–µ–ª–∏ reg.ru –Ω–∞ $CURRENT_IP"
    echo "‚è≥ –ü–æ–¥–æ–∂–¥–∏—Ç–µ 5-10 –º–∏–Ω—É—Ç –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è DNS –∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç —Å–Ω–æ–≤–∞"
    exit 1
fi

# –î–æ–ø. –ø—Ä–æ–≤–µ—Ä–∫–∞ IPv6: –µ—Å–ª–∏ –µ—Å—Ç—å AAAA-–∑–∞–ø–∏—Å—å –∏ –æ–Ω–∞ –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –Ω–∞—à–∏–º –ø—É–±–ª–∏—á–Ω—ã–º IPv6 ‚Äî –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º—Å—è
DOMAIN_IPV6=$(dig +short AAAA testdlyavsego.ru | head -n1)
CURRENT_IPV6=$(curl -6 -s ifconfig.me)
if [ -n "$DOMAIN_IPV6" ]; then
    echo "IPv6 –¥–æ–º–µ–Ω–∞: $DOMAIN_IPV6"
    if [ -z "$CURRENT_IPV6" ]; then
        echo "‚ùå –û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ AAAA-–∑–∞–ø–∏—Å—å $DOMAIN_IPV6, –Ω–æ —É —ç—Ç–æ–≥–æ —Ö–æ—Å—Ç–∞ –Ω–µ—Ç –ø—É–±–ª–∏—á–Ω–æ–≥–æ IPv6."
        echo "üõ† –£–¥–∞–ª–∏—Ç–µ –≤—Ä–µ–º–µ–Ω–Ω–æ AAAA-–∑–∞–ø–∏—Å—å –¥–ª—è testdlyavsego.ru –∏–ª–∏ —É–∫–∞–∂–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π IPv6 —ç—Ç–æ–≥–æ —Ö–æ—Å—Ç–∞, –∑–∞—Ç–µ–º –ø–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–æ–ø—ã—Ç–∫—É."
        exit 1
    fi
    if [ "$DOMAIN_IPV6" != "$CURRENT_IPV6" ]; then
        echo "‚ùå –ù–µ—Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ IPv6: –¥–æ–º–µ–Ω —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ $DOMAIN_IPV6, –∞ –ø—É–±–ª–∏—á–Ω—ã–π IPv6 —ç—Ç–æ–≥–æ —Ö–æ—Å—Ç–∞ $CURRENT_IPV6"
        echo "üõ† –õ–∏–±–æ –∏—Å–ø—Ä–∞–≤—å—Ç–µ AAAA-–∑–∞–ø–∏—Å—å –Ω–∞ $CURRENT_IPV6, –ª–∏–±–æ –≤—Ä–µ–º–µ–Ω–Ω–æ —É–¥–∞–ª–∏—Ç–µ AAAA, —á—Ç–æ–±—ã –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è —à–ª–∞ –ø–æ IPv4."
        exit 1
    fi
fi

echo "‚úÖ DNS –∑–∞–ø–∏—Å–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ"

# –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã –Ω–∞ –ø–æ—Ä—Ç–∞—Ö 80 –∏ 443
echo "üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤ –Ω–∞ –ø–æ—Ä—Ç–∞—Ö 80 –∏ 443..."
sudo lsof -ti:80 | xargs sudo kill -9 2>/dev/null || true
sudo lsof -ti:443 | xargs sudo kill -9 2>/dev/null || true

# –£–¥–∞–ª—ë–Ω –∑–∞–ø—É—Å–∫ –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞, —á—Ç–æ–±—ã certbot --standalone –º–æ–≥ –∑–∞–Ω—è—Ç—å –ø–æ—Ä—Ç 80
# –ó–∞–ø—É—Å–∫ –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞ —Ä–∞–Ω–µ–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞–ª –ø–æ—Ä—Ç 80 –∏ –º–µ—à–∞–ª certbot

# –í—ã–ø—É—Å–∫–∞–µ–º SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç
echo "üîê –í—ã–ø—É—Å–∫ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞..."
sudo certbot certonly --standalone --preferred-challenges http --http-01-address 0.0.0.0 --http-01-port 80 -d testdlyavsego.ru --non-interactive --agree-tos --email admin@testdlyavsego.ru

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç —Å–æ–∑–¥–∞–Ω
if [ -f "/etc/letsencrypt/live/testdlyavsego.ru/fullchain.pem" ]; then
    echo "‚úÖ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!"
    echo "üìÅ –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤: /etc/letsencrypt/live/testdlyavsego.ru/"
    echo ""
    echo "üîß –î–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞:"
    echo "   - –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –≤ –ø–∞–ø–∫—É –ø—Ä–æ–µ–∫—Ç–∞"
    echo "   - –ù–∞—Å—Ç—Ä–æ–π—Ç–µ nginx/apache –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è HTTPS"
    echo "   - –û–±–Ω–æ–≤–∏—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è"
else
    echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞"
    exit 1
fi
